!function(){function t(t){return $("<div>").text(t).html()}function e(t){return o.child(t)}function n(){a=location.hash.substr(1),s.id=window.localStorage.getItem("timeline.userid"),s.id?(c.get(s.id,function(t){s.name=t.username}),u.currentView=a?"account"==a?"account":"chat":"topics"):u.currentView="init"}var i=new MilkCocoa("https://io-si1g7tr3g.mlkcca.com:443/"),o=i.dataStore("topics"),c=i.dataStore("users"),a="",s={id:"",name:""},u=new Vue({el:"#content",data:{currentView:null}});Vue.component("topics",{template:"#topics-template",data:{topics:[],new_topic:""},filters:{topics_filter:function(t){return t}},ready:function(){this.fetch()},methods:{fetch:function(){var t=this;o.on("push",function(e){t.topics.unshift({topic_id:e.id,title:e.value.title})}),o.query({}).asc().limit(20).done(function(e){e&&(t.topics=e.map(function(t){return{topic_id:t.id,title:""==t.title?"トピック名が設定されていません":t.title}}).reverse())})},create:function(){this.new_topic&&(o.pushWithPriority({title:this.new_topic,user:s},(new Date).getTime()),this.new_topic="")},goto_chatroom:function(e){a=e,location.hash=t(a),u.currentView="chat"},goto_account:function(){location.hash="account",u.currentView="account"}}}),Vue.component("account",{template:"#account-template",data:{username:""},ready:function(){this.fetch()},methods:{fetch:function(){var t=this;c.get(s.id,function(e){t.username=e.username})},update:function(){var t=this;c.set(s.id,{username:t.username})}}}),Vue.component("init",{template:"#init-template",data:{username:""},ready:function(){},methods:{setting:function(){var t=this;c.push({username:t.username},function(t){window.localStorage.setItem("timeline.userid",t.id)}),u.currentView="topics"}}});Vue.component("chat",{template:"#chat-template",data:{title:"",messages:[],new_message:""},filters:{message_filter:function(t){return t}},ready:function(){this.fetch()},methods:{post:function(){this.new_message&&(e(a).push({content:t(this.new_message),user:s,timestamp:(new Date).getTime()}),this.new_message="",o.setPriority(a,(new Date).getTime()))},fetch:function(){var n=this;o.get(a,function(t){n.title=t.title,window.document.title=n.title}),e(a).on("push",function(e){n.messages.unshift({content:t(e.value.content),user:{name:t(e.value.user.name)}})}),e(a).query().sort("desc").limit(20).done(function(t){n.messages=t})}}});n(),window.onhashchange=function(){n()}}();